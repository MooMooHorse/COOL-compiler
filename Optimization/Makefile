# Makefile (completely generated by Github Copilot)

# Tools
LLVM_ROOT ?= /home/hao/COOL-compiler/llvm-project-15.0.0.src
CLANG = $(LLVM_ROOT)/bin/clang
OPT = $(LLVM_ROOT)/bin/opt
CMAKE = cmake
MAKE = make

# Build directory and plugin path
BUILD_DIR = /home/hao/COOL-compiler/Optimization/build
TEST_DIR = tests/testing
PLUGIN = $(BUILD_DIR)/libUnitProject.so

# Compiler and optimization options
CXXFLAGS = -c -O0 -Xclang -disable-O0-optnone -emit-llvm -S
OPT_PASSES = function(mem2reg,instcombine,simplifycfg,adce),inline,globaldce,function(sroa,early-cse,unit-sccp,jump-threading,correlated-propagation,simplifycfg,instcombine,simplifycfg,reassociate,unit-licm,adce,simplifycfg,instcombine),globaldce
LICM_PASS_OPT = function(mem2reg),function(unit-licm)
SCCP_PASS_OPT = function(mem2reg),function(unit-sccp)
CSE_PASS_OPT = function(mem2reg),function(unit-cse)




# Default output
OUTPUT = $(PROGRAM)

REAL_PROG = $(TEST_DIR)/$(PROGRAM)

# Build the shared library and optimize
all: $(PLUGIN)
	python3 end2end.py tests
$(PLUGIN):
	mkdir -p $(BUILD_DIR)
	cd $(BUILD_DIR) && $(CMAKE) ../ && $(MAKE) -j

no-optimize: # no optimization
	@if [ "$(PROGRAM)" = "" ]; then \
		echo "Error: Specify the <program> parameter"; \
		exit 1; \
	fi
	@if [ "$(OUTPUT)" = "" ]; then \
		OUTPUT=$(PROGRAM); \
	fi; \
	$(CLANG) $(REAL_PROG).c $(CXXFLAGS) -o - | \
	$(OPT) -verify-each -S -o result.ll; \
	cp result.ll $(TEST_DIR)/$(PROGRAM)-nooptimize.ll

optimize: $(PLUGIN) # optimize using human-readable LLVM IR
	@if [ "$(PROGRAM)" = "" ]; then \
		echo "Error: Specify the <program> parameter"; \
		exit 1; \
	fi
	@if [ "$(OUTPUT)" = "" ]; then \
		OUTPUT=$(PROGRAM); \
	fi; \
	$(OPT) -verify-each -load-pass-plugin=$(PLUGIN) -passes="$(OPT_PASSES)" -S $(TEST_DIR)/$(PROGRAM).ll -o result.ll; \
	cp result.ll $(TEST_DIR)/$(PROGRAM)-optimizeall.ll


optimize-licm: $(PLUGIN) # optimize using human-readable LLVM IR
	@if [ "$(PROGRAM)" = "" ]; then \
		echo "Error: Specify the <program> parameter"; \
		exit 1; \
	fi
	@if [ "$(OUTPUT)" = "" ]; then \
		OUTPUT=$(PROGRAM); \
	fi; \
	$(OPT) -verify-each -load-pass-plugin=$(PLUGIN) -passes="$(LICM_PASS_OPT)" -S $(TEST_DIR)/$(PROGRAM).ll -o result.ll; \
	cp result.ll $(TEST_DIR)/$(PROGRAM)-licm.ll

optimize-sccp: $(PLUGIN) # optimize using human-readable LLVM IR
	@if [ "$(PROGRAM)" = "" ]; then \
		echo "Error: Specify the <program> parameter"; \
		exit 1; \
	fi
	@if [ "$(OUTPUT)" = "" ]; then \
		OUTPUT=$(PROGRAM); \
	fi; \
	$(OPT) -verify-each -load-pass-plugin=$(PLUGIN) -passes="$(SCCP_PASS_OPT)" -S $(TEST_DIR)/$(PROGRAM).ll -o result.ll; \
	cp result.ll $(TEST_DIR)/$(PROGRAM)-sccp.ll

optimize-cse: $(PLUGIN) # optimize using human-readable LLVM IR
	@if [ "$(PROGRAM)" = "" ]; then \
		echo "Error: Specify the <program> parameter"; \
		exit 1; \
	fi
	@if [ "$(OUTPUT)" = "" ]; then \
		OUTPUT=$(PROGRAM); \
	fi; \
	$(OPT) -verify-each -load-pass-plugin=$(PLUGIN) -passes="$(CSE_PASS_OPT)" -S $(TEST_DIR)/$(PROGRAM).ll -o result.ll; \
	cp result.ll $(TEST_DIR)/$(PROGRAM)-cse.ll


optimize-real: # optimize using real C++ file
	@if [ "$(PROGRAM)" = "" ]; then \
		echo "Error: Specify the <program> parameter"; \
		exit 1; \
	fi
	@if [ "$(OUTPUT)" = "" ]; then \
		OUTPUT=$(PROGRAM); \
	fi; \
	$(CLANG) $(REAL_PROG).c $(CXXFLAGS) -o - | \
	$(OPT) -verify-each -load-pass-plugin=$(PLUGIN) -passes="$(OPT_PASSES)" -S  -o result.ll; \
	cp result.ll $(TEST_DIR)/$(PROGRAM)-all.ll


optimize-real-licm: # optimize using real C++ file
	@if [ "$(PROGRAM)" = "" ]; then \
		echo "Error: Specify the <program> parameter"; \
		exit 1; \
	fi
	@if [ "$(OUTPUT)" = "" ]; then \
		OUTPUT=$(PROGRAM); \
	fi; \
	$(CLANG) $(REAL_PROG).c $(CXXFLAGS) -o - | \
	$(OPT) -verify-each -load-pass-plugin=$(PLUGIN) -passes="$(LICM_PASS_OPT)" -S  -o result.ll; \
	cp result.ll $(TEST_DIR)/$(PROGRAM)-licm.ll

optimize-real-sccp: # optimize using real C++ file
	@if [ "$(PROGRAM)" = "" ]; then \
		echo "Error: Specify the <program> parameter"; \
		exit 1; \
	fi
	@if [ "$(OUTPUT)" = "" ]; then \
		OUTPUT=$(PROGRAM); \
	fi; \
	$(CLANG) $(REAL_PROG).c $(CXXFLAGS) -o - | \
	$(OPT) -verify-each -load-pass-plugin=$(PLUGIN) -passes="$(SCCP_PASS_OPT)" -S  -o result.ll; \
	cp result.ll $(TEST_DIR)/$(PROGRAM)-sccp.ll

optimize-real-cse: # optimize using real C++ file
	@if [ "$(PROGRAM)" = "" ]; then \
		echo "Error: Specify the <program> parameter"; \
		exit 1; \
	fi
	@if [ "$(OUTPUT)" = "" ]; then \
		OUTPUT=$(PROGRAM); \
	fi; \
	$(CLANG) $(REAL_PROG).c $(CXXFLAGS) -o - | \
	$(OPT) -verify-each -load-pass-plugin=$(PLUGIN) -passes="$(CSE_PASS_OPT)" -S  -o result.ll; \
	cp result.ll $(TEST_DIR)/$(PROGRAM)-cse.ll



run:
	$(CLANG) result.ll -o result

clean:
	rm -rf $(BUILD_DIR) $(OUTPUT)

.PHONY: all clean optimize